import e from"qrcodejs2-fixes";import t from"md5";const r=(e,t,r)=>{const i=Object.assign({},e),a=i[t];return a&&r&&(delete i[t],i[r]=a),i},i={errno:10001,errmsg:"[mix img err] 创建canvas标签出错！"},a={errno:20001,errmsg:"[mix img err] 绘制背景图出错！"},n={errno:30001,errmsg:"[mix img err] 添加动态元素错误！"},o={errno:300011,errmsg:"[mix img err] 添加文字错误！"},s={errno:300012,errmsg:"[mix img err] 添加图片错误！"},c={errno:30002,errmsg:"[mix img err] 添加二维码错误！"},l={errno:40001,errmsg:"[mix img err] canvas转base64出错！"},g={errno:90001,errmsg:"[mix img err] 创建img标签出错！请排查该图片是否跨域"},m={errno:90002,errmsg:"[mix img err] 创建img标签超时！"},d=(e,t=5e3)=>new Promise(((r,i)=>{const a=new Image;a.crossOrigin="Anonymous",a.src=e,setTimeout((()=>{i(Object.assign({},m,{err:`img response time more than ${t} ms`,errSrc:e}))}),t),a.onload=()=>{r(a)},a.onerror=t=>{i(Object.assign({},g,{err:t,errSrc:e}))}})),u=(e,t={})=>{const r=/(.*)({(.*)})(.*)/g.exec(e);return r?r[1]+t[r[3]]+r[4]:e},h=async(e,t={},r)=>{try{var i,a,n,s,c,l,g,m;if(!t.text)return;const o=null!==(i=t.style)&&void 0!==i&&i.fontSize?`${t.style.fontSize}px`:"20px",y=null!==(a=t.style)&&void 0!==a&&a.fontWeight?`${t.style.fontWeight}`:"normal",v="ios"===(()=>{let e="";return e=/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)?"ios":/(Android)/i.test(navigator.userAgent)?"android":"pc",e})()?"PingFang SC":"Roboto",x=null!==(n=t.style)&&void 0!==n&&n.fontFamily?`${t.style.fontFamily}, ${v}`:v,f=t.font?t.font:`${y} ${o} ${x}`;try{var d,h;(null===(d=document)||void 0===d||null===(h=d.fonts)||void 0===h?void 0:h.load)&&await document.fonts.load(f)}catch(e){console.error("[Font loading failed]",e)}e.fillStyle=null===(s=t.style)||void 0===s?void 0:s.color,e.font=f,e.textAlign=null!==(c=t.style)&&void 0!==c&&c.textAlign?t.style.textAlign:"left",e.textBaseline=null!==(l=t.style)&&void 0!==l&&l.textBaseline?t.style.textBaseline:"alphabetic";const w=u(t.text,r);e.fillText(w,(null===(g=t.position)||void 0===g?void 0:g.x)||0,(null===(m=t.position)||void 0===m?void 0:m.y)||0)}catch(e){return Promise.reject(Object.assign({},o,{err:e}))}},y=async(e,t={},r,i)=>{try{var a,n;if(!t.imgUrl)return;const s=t.imgUrl.startsWith("data:image")?t.imgUrl:u(t.imgUrl,r),l=await d(s,i);let g=l.width,m=l.height;var o,c;if(t.size&&t.size.dWidth&&t.size.dHeight&&(g=t.size.dWidth,m=t.size.dHeight),e.save(),t.isRound)((e,t,r,i,a)=>{e.beginPath(),e.arc(t+i,r+a,t,0,2*Math.PI),e.clip()})(e,g/2,m/2,null===(o=t.position)||void 0===o?void 0:o.x,null===(c=t.position)||void 0===c?void 0:c.y);e.drawImage(l,null===(a=t.position)||void 0===a?void 0:a.x,null===(n=t.position)||void 0===n?void 0:n.y,g,m),e.restore()}catch(e){return Promise.reject(Object.assign({},s,{err:e}))}},v=async t=>{try{var i;let{ctx:a,qrCode:n,replaceText:o}=t;if(null!==(i=n)&&void 0!==i&&i.text&&n.width&&n.height){n.text=u(n.text,o),n=r(n,"foreground","colorDark"),n=r(n,"background","colorLight");const t=await(t=>new Promise(((r,i)=>{const a=Object.assign({width:70,height:70,colorDark:"#000000",colorLight:"#ffffff",correctLevel:e.CorrectLevel.L},t,{text:""}),n=document.createElement("div");new e(n,a).makeCode(t.text),r(n.getElementsByTagName("canvas")[0])})))(n);a.drawImage(t,n.x||0,n.y||0,n.width,n.height)}return"canvas"===t.base.dataType?{canvas:t.canvasImg}:t}catch(e){return Promise.reject(Object.assign({},c,{err:e}))}},x=e=>{try{const t="_mixImgCanvas",{width:r,height:i}=e.base;let a=document.getElementById(t);a||(a=document.createElement("canvas"),a.id=t),a.width=r,a.height=i;const n=a.getContext("2d");return n.clearRect(0,0,a.width,a.height),Object.assign({canvasImg:a,ctx:n},e)}catch(e){return Promise.reject(Object.assign({},i,{err:e}))}};let f="";const w=async e=>{try{const{base:t,ctx:r}=e,i=t.width||300,a=t.height||300;if(t.backgroundImg){const e=await d(t.backgroundImg,t.loadingTimeout);r.drawImage(e,0,0,i,a)}return e}catch(e){return Promise.reject(Object.assign({},a,{err:e}))}},b=async e=>{try{const{ctx:i,dynamic:a=[],replaceText:n}=e,o=e.base.loadingTimeout;let s=(t="weight",r=0,a.reduce(((e,i)=>{let a=i[t]||r;return e[a]||(e[a]=[]),e[a].push(i),e}),{})),c=Object.keys(s);c.sort((function(e,t){return e-t}));for(let e of c){let t=[],r=s[e];for(let e=0;e<r.length;e++)1===r[e].type?t.push(y(i,r[e],n,o)):t.push(h(i,r[e],n));await Promise.all(t)}return e}catch(e){return Promise.reject(Object.assign({},n,{err:e}))}var t,r},p=e=>{try{let t=JSON.parse(localStorage.getItem("mix_img_base64_queue"))||[];t.push(`mix_img_base64_${f}`),t.length>2&&localStorage.removeItem(t.shift()),localStorage.setItem("mix_img_base64_queue",JSON.stringify(t)),localStorage.setItem(`mix_img_base64_${f}`,e)}catch(e){console.log(`[mix img log] ${e}`)}},j=async e=>{const{canvasImg:t,base:r,dev:i}=e,a=await((e,t={})=>{try{const r=t.fileType?`image/${t.fileType}`:"image/jpeg",i=t.quality||.8;return e.toDataURL(r,i)}catch(e){return Promise.reject(Object.assign({},l,{err:e}))}})(t,{fileType:r.fileType,quality:r.quality});return null!=i&&i.notUseCache||p(a),{base64:a}},O=async e=>{var t,r,i,a;return a=e,i=await x(a),r=await w(i),t=await b(r),await v(t)},I=async e=>{var r,i,a,n,o,s;f=t(JSON.stringify(e));const c=null!==(r=e.dev)&&void 0!==r&&r.notUseCache?"":localStorage.getItem(`mix_img_base64_${f}`);return c?{base64:c}:(s=e,o=await x(s),n=await w(o),a=await b(n),i=await v(a),await j(i))},S=async e=>{const t=(new Date).getTime();try{let r=JSON.parse(JSON.stringify(e)),i="canvas"===r.base.dataType?await O(r):await I(r);return console.log(`[mix img time] ${(new Date).getTime()-t} ms`),{errno:0,data:i}}catch(e){return e}};export{w as addBackgroundImg,b as addDynamicElementToCanvas,p as cacheFile,j as getBase64,S as mixImg,I as processBase64,O as processCanvas};
